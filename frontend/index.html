<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS Dashboard</title>
    <style>
      :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --bg: #f8fafc;
        --card-bg: #ffffff;
        --text: #1e293b;
        --text-light: #64748b;
        --border: #e2e8f0;
        --success: #10b981;
        --error: #ef4444;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
      }

      body {
        background-color: var(--bg);
        color: var(--text);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 250px;
        background-color: var(--card-bg);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-item {
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-light);
        font-weight: 500;
      }

      .nav-item:hover,
      .nav-item.active {
        background-color: #eff6ff;
        color: var(--primary);
      }

      .nav-item.logout {
        margin-top: auto;
        color: var(--error);
      }
      .nav-item.logout:hover {
        background-color: #fef2f2;
      }

      /* Main Content */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        height: 64px;
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 2rem;
        justify-content: space-between;
      }

      .user-info {
        font-size: 0.875rem;
        color: var(--text-light);
      }

      .content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 2rem;
      }

      /* Views */
      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      .card {
        background-color: var(--card-bg);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      h2 {
        margin-bottom: 1.5rem;
        font-size: 1.25rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-light);
      }

      input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        outline: none;
        transition: border-color 0.2s;
      }

      input:focus {
        border-color: var(--primary);
      }

      button {
        width: 100%;
        padding: 0.75rem;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: var(--primary-hover);
      }

      button.secondary {
        background-color: transparent;
        color: var(--text-light);
        border: 1px solid var(--border);
      }

      button.secondary:hover {
        background-color: #f1f5f9;
        color: var(--text);
      }

      /* Logs Panel */
      .logs-panel {
        background-color: #1e293b;
        color: #e2e8f0;
        border-radius: 1rem;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: calc(100vh - 64px - 4rem);
      }

      .logs-header {
        padding: 1rem;
        background-color: #0f172a;
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logs-content {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .log-entry {
        padding: 0.5rem;
        border-radius: 0.25rem;
        background-color: #334155;
        word-break: break-all;
      }

      .log-entry.req {
        border-left: 3px solid var(--primary);
      }
      .log-entry.res-ok {
        border-left: 3px solid var(--success);
      }
      .log-entry.res-err {
        border-left: 3px solid var(--error);
      }

      .log-time {
        color: #94a3b8;
        font-size: 0.7rem;
        margin-bottom: 0.25rem;
      }
      .log-method {
        font-weight: bold;
        color: #fff;
      }
      .log-url {
        color: #60a5fa;
      }
      .log-status {
        font-weight: bold;
      }

      /* Auth specific */
      .auth-container {
        max-width: 400px;
        margin: 0 auto;
      }

      .hidden {
        display: none !important;
      }

      /* Artifacts List */
      .artifact-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }

      .artifact-card {
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        overflow: hidden;
        transition: transform 0.2s;
      }

      .artifact-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .artifact-img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        background-color: #f1f5f9;
      }

      .artifact-info {
        padding: 0.75rem;
      }

      .artifact-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
      }

      .like-btn {
        background: none;
        color: var(--text-light);
        padding: 0.25rem 0.5rem;
        width: auto;
        font-size: 0.875rem;
        border: 1px solid transparent;
      }

      .like-btn:hover {
        background-color: #fee2e2;
        color: var(--error);
      }

      .like-count {
        font-size: 0.75rem;
        color: var(--text-light);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background-color: #333;
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(150%);
        transition: transform 0.3s;
        z-index: 1000;
      }
      .toast.show {
        transform: translateY(0);
      }
      .toast.success {
        background-color: var(--success);
      }
      .toast.error {
        background-color: var(--error);
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo"><span>⚡</span> CMS Admin</div>

      <div class="nav-item active" onclick="switchView('auth')">
        Authentication
      </div>
      <div class="nav-item" onclick="switchView('artifacts')">Artifacts</div>

      <div class="nav-item logout" onclick="logout()">Logout</div>
    </div>

    <!-- Main Content -->
    <div class="main">
      <div class="header">
        <h3>Dashboard</h3>
        <div class="user-info" id="userInfo">Not Logged In</div>
      </div>

      <div class="content">
        <!-- Left Side: Interactive Views -->
        <div class="interactive-area">
          <!-- Auth View -->
          <div id="auth" class="view active">
            <div class="auth-container">
              <!-- Login Form -->
              <div id="loginForm" class="card">
                <h2>Login</h2>
                <div class="form-group">
                  <label>Email</label>
                  <input
                    type="email"
                    id="loginEmail"
                    placeholder="admin@example.com"
                  />
                </div>
                <div class="form-group">
                  <label>Password</label>
                  <input
                    type="password"
                    id="loginPassword"
                    placeholder="******"
                  />
                </div>
                <button onclick="handleLogin()">Login</button>
                <div
                  style="
                    text-align: center;
                    margin-top: 1rem;
                    font-size: 0.875rem;
                  "
                >
                  <a href="#" onclick="toggleAuthMode('signup')"
                    >Need an account? Sign Up</a
                  >
                </div>
              </div>

              <!-- Signup Initiate -->
              <div id="signupInitiateForm" class="card hidden">
                <h2>Sign Up</h2>
                <div class="form-group">
                  <label>Email</label>
                  <input
                    type="email"
                    id="signupEmail"
                    placeholder="newuser@example.com"
                  />
                </div>
                <button onclick="handleSignupInitiate()">Send OTP</button>
                <div
                  style="
                    text-align: center;
                    margin-top: 1rem;
                    font-size: 0.875rem;
                  "
                >
                  <a href="#" onclick="toggleAuthMode('login')"
                    >Already have an account? Login</a
                  >
                </div>
              </div>

              <!-- Signup Verify -->
              <div id="signupVerifyForm" class="card hidden">
                <h2>Verify OTP</h2>
                <p
                  style="
                    margin-bottom: 1rem;
                    font-size: 0.875rem;
                    color: var(--text-light);
                  "
                >
                  Enter the OTP sent to
                  <span id="verifyingEmail" style="font-weight: bold"></span>
                </p>
                <div class="form-group">
                  <label>OTP</label>
                  <input type="text" id="signupOtp" placeholder="123456" />
                </div>
                <div class="form-group">
                  <label>Detailed Name</label>
                  <input type="text" id="signupName" placeholder="John Doe" />
                </div>
                <div class="form-group">
                  <label>Password</label>
                  <input
                    type="password"
                    id="signupPassword"
                    placeholder="******"
                  />
                </div>
                <button onclick="handleSignupVerify()">
                  Verify & Create Account
                </button>
                <button
                  class="secondary"
                  style="margin-top: 0.5rem"
                  onclick="toggleAuthMode('signup')"
                >
                  Back
                </button>
              </div>
            </div>
          </div>

          <!-- Artifacts View -->
          <div id="artifacts" class="view">
            <div class="card">
              <h2>Create Artifact (Admin/Editor)</h2>
              <div class="form-group">
                <label>Upload File</label>
                <input type="file" id="artifactFile" />
              </div>
              <button onclick="handleCreateArtifact()">Upload</button>
            </div>

            <div class="card">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 1rem;
                "
              >
                <h2>All Artifacts</h2>
                <button
                  class="secondary"
                  style="width: auto"
                  onclick="loadArtifacts()"
                >
                  Refresh
                </button>
              </div>
              <div id="artifactsList" class="artifact-grid">
                <!-- Populated by JS -->
                <div
                  style="
                    grid-column: 1/-1;
                    text-align: center;
                    color: var(--text-light);
                    padding: 2rem;
                  "
                >
                  Click Refresh to load artifacts...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side: Logger -->
        <div class="logs-panel">
          <div class="logs-header">
            <span>API Logs</span>
            <button
              style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.75rem"
              onclick="clearLogs()"
            >
              Clear
            </button>
          </div>
          <div id="logsContent" class="logs-content">
            <div class="log-entry">Waiting for requests...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Message here</div>

    <script>
      const API_BASE_URL = "https://king-prawn-app-yvh23.ondigitalocean.app";
      let CURRENT_USER = null;
      let TOKEN = localStorage.getItem("token");

      // Check auth on load
      if (TOKEN) {
        // Optimistically set logged in state, verify with an API call ideally
        updateUIState(true);
      } else {
        updateUIState(false);
      }

      /* --- UI Logic --- */

      function switchView(viewId) {
        document
          .querySelectorAll(".view")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(viewId).classList.add("active");

        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelector(`.nav-item[onclick="switchView('${viewId}')"]`)
          .classList.add("active");

        if (viewId === "artifacts" && TOKEN) {
          loadArtifacts();
        }
      }

      function toggleAuthMode(mode) {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("signupInitiateForm").classList.add("hidden");
        document.getElementById("signupVerifyForm").classList.add("hidden");

        if (mode === "login")
          document.getElementById("loginForm").classList.remove("hidden");
        if (mode === "signup")
          document
            .getElementById("signupInitiateForm")
            .classList.remove("hidden");
      }

      function showSignupVerify(email) {
        toggleAuthMode("none");
        document.getElementById("signupVerifyForm").classList.remove("hidden");
        document.getElementById("verifyingEmail").innerText = email;
      }

      function updateUIState(isLoggedIn) {
        const userInfo = document.getElementById("userInfo");
        if (isLoggedIn) {
          userInfo.innerText = "Logged In";
        } else {
          userInfo.innerText = "Not Logged In";
          switchView("auth");
        }
      }

      function showToast(msg, type = "success") {
        const toast = document.getElementById("toast");
        toast.innerText = msg;
        toast.className = `toast show ${type}`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function log(method, url, data, type = "req") {
        const container = document.getElementById("logsContent");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;

        const time = new Date().toLocaleTimeString();
        let content = `<div class="log-time">${time}</div>`;

        if (type === "req") {
          content += `<div><span class="log-method">${method}</span> <span class="log-url">${url.split(API_BASE_URL)[1] || url}</span></div>`;
        } else {
          content += `<div><span class="log-status">Response</span></div>`;
        }

        if (data) {
          try {
            content += `<div style="margin-top: 0.25rem; white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</div>`;
          } catch (e) {}
        }

        entry.innerHTML = content;
        container.prepend(entry); // Newest first
      }

      function clearLogs() {
        document.getElementById("logsContent").innerHTML = "";
      }

      /* --- API Interaction --- */

      async function apiCall(
        endpoint,
        method,
        body = null,
        isFormData = false,
      ) {
        const url = `${API_BASE_URL}${endpoint}`;
        log(method, url, body);

        const headers = {};
        if (TOKEN) headers["Authorization"] = `Bearer ${TOKEN}`;
        if (!isFormData) headers["Content-Type"] = "application/json";

        try {
          const options = {
            method,
            headers,
          };
          if (body) options.body = isFormData ? body : JSON.stringify(body);

          const res = await fetch(url, options);
          let data;
          const contentType = res.headers.get("content-type");
          if (contentType && contentType.indexOf("application/json") !== -1) {
            data = await res.json();
          } else {
            data = await res.text();
          }

          log(method, url, data, res.ok ? "res-ok" : "res-err");

          if (!res.ok) {
            throw new Error(data.message || data.error || "API Error");
          }

          return data;
        } catch (error) {
          log(method, url, { error: error.message }, "res-err");
          showToast(error.message, "error");
          throw error;
        }
      }

      /* --- Handlers --- */

      async function handleLogin() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
          const res = await apiCall("/auth/login", "POST", { email, password });
          if (res.token) {
            TOKEN = res.token;
            localStorage.setItem("token", TOKEN);
            updateUIState(true);
            showToast("Login Successful!");
            switchView("artifacts");
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function handleSignupInitiate() {
        const email = document.getElementById("signupEmail").value;
        try {
          await apiCall("/auth/signup/initiate", "POST", { email });
          showToast("OTP Sent!");
          showSignupVerify(email);
        } catch (e) {
          console.error(e);
        }
      }

      async function handleSignupVerify() {
        const email = document.getElementById("verifyingEmail").innerText;
        const otp = document.getElementById("signupOtp").value;
        const name = document.getElementById("signupName").value;
        const password = document.getElementById("signupPassword").value;

        try {
          await apiCall("/auth/signup/verify", "POST", {
            email,
            otp,
            name,
            password,
          });
          showToast("Account Created! Please Login.");
          toggleAuthMode("login");
        } catch (e) {
          console.error(e);
        }
      }

      function logout() {
        TOKEN = null;
        localStorage.removeItem("token");
        updateUIState(false);
        showToast("Logged Out");
      }

      async function handleCreateArtifact() {
        const fileInput = document.getElementById("artifactFile");
        if (fileInput.files.length === 0) {
          showToast("Select a file first", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
          await apiCall("/artifacts", "POST", formData, true);
          showToast("Artifact Created!");
          fileInput.value = "";
          loadArtifacts();
        } catch (e) {
          console.error(e);
        }
      }

      async function loadArtifacts() {
        const listEl = document.getElementById("artifactsList");
        listEl.innerHTML =
          '<div style="color: grey; padding: 1rem;">Loading...</div>';

        try {
          const res = await apiCall("/artifacts", "GET");
          // Assuming res is an array or { artifacts: [...] }
          const artifacts = Array.isArray(res) ? res : res.artifacts || [];

          if (artifacts.length === 0) {
            listEl.innerHTML =
              '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: gray;">No artifacts found.</div>';
            return;
          }

          listEl.innerHTML = artifacts
            .map(
              (art) => `
                    <div class="artifact-card">
                        <img src="${art.url || "https://via.placeholder.com/150"}" class="artifact-img" alt="Artifact">
                        <div class="artifact-info">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">${art.originalName || "Artifact"}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${new Date(art.createdAt).toLocaleDateString()}</div>
                            <div class="artifact-actions">
                                <button class="like-btn" onclick="toggleLike('${art._id}')">
                                    ♥ <span id="likes-${art._id}">${art.likes ? art.likes.length : 0}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `,
            )
            .join("");
        } catch (e) {
          listEl.innerHTML = `<div style="color: red; padding: 1rem;">Failed to load. ${e.message}</div>`;
        }
      }

      async function toggleLike(id) {
        try {
          // Adjust endpoint based on your backend
          const res = await apiCall(`/artifacts/${id}/like`, "POST");
          loadArtifacts(); // Reload to get fresh count
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
