<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Dashboard v2</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            flex-shrink: 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-light);
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active {
            background-color: #eff6ff;
            color: var(--primary);
        }

        .nav-item.logout {
            margin-top: auto;
            color: var(--error);
        }
        .nav-item.logout:hover {
            background-color: #fef2f2;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            height: 64px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .user-info {
            font-size: 0.875rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .role-badge {
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        h2 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
            background-color: white;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }
        
        button.secondary {
            background-color: transparent;
            color: var(--text-light);
            border: 1px solid var(--border);
        }
        
        button.secondary:hover {
            background-color: #f1f5f9;
            color: var(--text);
        }

        /* Logs Panel & Inspector */
        .side-panel {
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: calc(100vh - 64px - 4rem);
        }

        .panel-header {
            padding: 1rem;
            background-color: #0f172a;
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-tabs {
            display: flex;
            background-color: #0f172a;
            padding: 0 1rem;
            border-bottom: 1px solid #334155;
        }
        
        .panel-tab {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .panel-tab.active {
            color: white;
            border-bottom-color: var(--primary);
        }

        .panel-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .inspector-section {
            display: none;
        }
        .inspector-section.active { display: flex; flex-direction: column; gap: 1rem; }

        .log-entry {
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: #334155;
            word-break: break-all;
        }

        .log-entry.req { border-left: 3px solid var(--primary); }
        .log-entry.res-ok { border-left: 3px solid var(--success); }
        .log-entry.res-err { border-left: 3px solid var(--error); }

        .log-time { color: #94a3b8; font-size: 0.7rem; margin-bottom: 0.25rem; }
        .log-method { font-weight: bold; color: #fff; }
        .log-url { color: #60a5fa; }
        .log-status { font-weight: bold; }

        /* Storage Table */
        .storage-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .storage-table th, .storage-table td {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid #334155;
        }
        .storage-table th { color: #94a3b8; }
        .storage-key { color: var(--warning); font-weight: bold; }
        .storage-val { color: #e2e8f0; word-break: break-all; }

        /* Auth specific */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .hidden { display: none !important; }

        /* Artifacts List */
        .artifact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .artifact-card {
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            overflow: hidden;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .artifact-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .artifact-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background-color: #f1f5f9;
        }
        
        .artifact-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .artifact-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1.125rem;
        }
        
        .artifact-desc {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .artifact-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-light);
            border-top: 1px solid var(--border);
            padding-top: 0.75rem;
            margin-top: auto;
        }
        
        .status-badge {
            font-size: 0.65rem;
            padding: 0.125rem 0.375rem;
            border-radius: 999px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .status-DRAFT { background-color: #f3f4f6; color: #4b5563; }
        .status-PUBLISHED { background-color: #dcfce7; color: #166534; }
        .status-ARCHIVED { background-color: #fef2f2; color: #991b1b; }

        .like-btn {
            background: none;
            color: var(--text-light);
            padding: 0;
            width: auto;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }
        
        .like-btn:hover { background: none; color: var(--error); }
        .like-btn.liked { color: var(--error); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background-color: #333;
            color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(150%);
            transition: transform 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateY(0); }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--error); }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <span>⚡</span> CMS Admin
        </div>
        
        <div class="nav-item active" onclick="switchView('auth')">Authentication</div>
        <div class="nav-item" onclick="switchView('artifacts')">Artifacts</div>
        
        <div class="nav-item logout" onclick="logout()">Logout</div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="header">
            <h3>Dashboard</h3>
            <div class="user-info" id="userInfo">
                <span>Not Logged In</span>
            </div>
        </div>

        <div class="content">
            <!-- Left Side: Interactive Views -->
            <div class="interactive-area">
                
                <!-- Auth View -->
                <div id="auth" class="view active">
                    <div class="auth-container">
                        
                        <!-- Login Form -->
                        <div id="loginForm" class="card">
                            <h2>Login</h2>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="loginEmail" placeholder="admin@example.com">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="loginPassword" placeholder="******">
                            </div>
                            <button onclick="handleLogin()">Login</button>
                            <div style="text-align: center; margin-top: 1rem; font-size: 0.875rem;">
                                <a href="#" onclick="toggleAuthMode('signup')">Need an account? Sign Up</a>
                            </div>
                        </div>

                        <!-- Signup Initiate -->
                        <div id="signupInitiateForm" class="card hidden">
                            <h2>Sign Up</h2>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="signupEmail" placeholder="newuser@example.com">
                            </div>
                            <button onclick="handleSignupInitiate()">Send OTP</button>
                            <div style="text-align: center; margin-top: 1rem; font-size: 0.875rem;">
                                <a href="#" onclick="toggleAuthMode('login')">Already have an account? Login</a>
                            </div>
                        </div>

                        <!-- Signup Verify -->
                        <div id="signupVerifyForm" class="card hidden">
                            <h2>Verify OTP & Create Account</h2>
                            <p style="margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-light);">
                                Enter the OTP sent to <span id="verifyingEmail" style="font-weight: bold;"></span>
                            </p>
                            <div class="form-group">
                                <label>OTP</label>
                                <input type="text" id="signupOtp" placeholder="123456">
                            </div>
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="signupName" placeholder="John Doe">
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="signupRole">
                                    <option value="VIEWER">VIEWER (Read Only)</option>
                                    <option value="EDITOR">EDITOR (Create Artifacts)</option>
                                    <option value="ADMIN">ADMIN (Full Access)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="signupPassword" placeholder="******">
                            </div>
                            <button onclick="handleSignupVerify()">Verify & Create Account</button>
                            <button class="secondary" style="margin-top: 0.5rem;" onclick="toggleAuthMode('signup')">Back</button>
                        </div>

                    </div>
                </div>

                <!-- Artifacts View -->
                <div id="artifacts" class="view">
                    <!-- Create Form -->
                    <div class="card">
                        <h2>Create New Artifact</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="artTitle" placeholder="My Awesome Post">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="artStatus">
                                    <option value="DRAFT">Draft</option>
                                    <option value="PUBLISHED">Published</option>
                                    <option value="ARCHIVED">Archived</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Content</label>
                            <textarea id="artContent" placeholder="Write something amazing..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Upload Media (Image/PDF)</label>
                            <input type="file" id="artFile">
                        </div>
                        <button onclick="handleCreateArtifact()">Create Artifact</button>
                    </div>

                    <!-- List -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2>Artifacts Library</h2>
                            <button class="secondary" style="width: auto;" onclick="loadArtifacts()">Refresh</button>
                        </div>
                        <div id="artifactsList" class="artifact-grid">
                            <!-- Populated by JS -->
                            <div style="grid-column: 1/-1; text-align: center; color: var(--text-light); padding: 2rem;">
                                Click Refresh to load artifacts...
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Side: Side Panel -->
            <div class="side-panel">
                <div class="panel-header">
                    <span>Developer Tools</span>
                    <button style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="clearLogs()">Clear Logs</button>
                </div>
                <div class="panel-tabs">
                    <div class="panel-tab active" onclick="switchPanelTab('logs')">Network Logs</div>
                    <div class="panel-tab" onclick="switchPanelTab('storage')">Storage & Cookies</div>
                </div>
                
                <div id="logsContent" class="panel-content inspector-section active">
                    <div class="log-entry">Waiting for requests...</div>
                </div>
                
                <div id="storageContent" class="panel-content inspector-section">
                    <div style="margin-bottom: 1rem;">
                        <div style="color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 0.5rem;">Local Storage</div>
                        <table class="storage-table" id="localStorageTable">
                            <tbody><tr><td colspan="2">Empty</td></tr></tbody>
                        </table>
                    </div>
                    
                    <div>
                        <div style="color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 0.5rem;">Cookies (Visible)</div>
                        <div id="cookiesList" style="font-size: 0.75rem; color: #e2e8f0; margin-bottom: 0.5rem;">No visible cookies</div>
                        <div class="log-entry" style="font-style: italic; color: #94a3b8; border: 1px dashed #475569;">
                            Note: HttpOnly cookies (like 'token') are hidden from JavaScript for security but are sent automatically with requests.
                        </div>
                    </div>
                    <button class="secondary" style="margin-top: 1rem; width: auto; font-size: 0.75rem;" onclick="updateStorageInspector()">Refresh Inspector</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Message here</div>

    <script>
        const API_BASE_URL = "https://king-prawn-app-yvh23.ondigitalocean.app";
        let CURRENT_USER = null;
        let TOKEN = localStorage.getItem('token');

        // Initial Load
        updateStorageInspector();
        if (TOKEN) {
            updateUIState(true);
        } else {
            updateUIState(false);
        }

        /* --- UI Logic --- */

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="switchView('${viewId}')"]`).classList.add('active');

            if(viewId === 'artifacts' && TOKEN) {
                loadArtifacts();
            }
        }
        
        function switchPanelTab(tabId) {
            document.querySelectorAll('.panel-tab').forEach(el => el.classList.remove('active'));
            // Find tab by text content mostly or index if simpler, but here matching onclick
            if(tabId === 'logs') document.querySelector('.panel-tab:first-child').classList.add('active');
            else document.querySelector('.panel-tab:last-child').classList.add('active');
            
            document.querySelectorAll('.inspector-section').forEach(el => el.classList.remove('active'));
            if(tabId === 'logs') document.getElementById('logsContent').classList.add('active');
            else {
                document.getElementById('storageContent').classList.add('active');
                updateStorageInspector();
            }
        }

        function toggleAuthMode(mode) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupInitiateForm').classList.add('hidden');
            document.getElementById('signupVerifyForm').classList.add('hidden');

            if (mode === 'login') document.getElementById('loginForm').classList.remove('hidden');
            if (mode === 'signup') document.getElementById('signupInitiateForm').classList.remove('hidden');
        }

        function showSignupVerify(email) {
            toggleAuthMode('none');
            document.getElementById('signupVerifyForm').classList.remove('hidden');
            document.getElementById('verifyingEmail').innerText = email;
        }

        function updateUIState(isLoggedIn) {
            const userInfo = document.getElementById('userInfo');
            
            // Try to decode token to get user info if available
            let userDisplay = 'Logged In';
            let role = '';
            
            if (TOKEN) {
                try {
                    const payload = JSON.parse(atob(TOKEN.split('.')[1]));
                    if(payload.role) role = payload.role;
                    // payload might have id, but name is usually separate. 
                    // Ideally /me endpoint should fetch profile.
                } catch(e) {}
            }

            if (isLoggedIn) {
                userInfo.innerHTML = `
                    <span>User</span>
                    ${role ? `<span class="role-badge">${role}</span>` : ''}
                `;
            } else {
                userInfo.innerHTML = '<span>Not Logged In</span>';
                switchView('auth');
            }
            updateStorageInspector();
        }

        function updateStorageInspector() {
            // Local Storage
            const lsTable = document.getElementById('localStorageTable').querySelector('tbody');
            lsTable.innerHTML = '';
            if (localStorage.length === 0) {
                lsTable.innerHTML = '<tr><td colspan="2" style="color: grey;">Empty</td></tr>';
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const val = localStorage.getItem(key);
                    lsTable.innerHTML += `
                        <tr>
                            <td class="storage-key">${key}</td>
                            <td class="storage-val">${val.substring(0, 50)}${val.length > 50 ? '...' : ''}</td>
                        </tr>
                    `;
                }
            }
            
            // Cookies
            const cookiesDiv = document.getElementById('cookiesList');
            if (document.cookie) {
                cookiesDiv.innerText = document.cookie;
            } else {
                cookiesDiv.innerText = "No visible cookies (HttpOnly cookies handled by browser)";
            }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function log(method, url, data, type = 'req') {
            const container = document.getElementById('logsContent');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString();
            let content = `<div class="log-time">${time}</div>`;
            
            if (type === 'req') {
                content += `<div><span class="log-method">${method}</span> <span class="log-url">${url.split(API_BASE_URL)[1] || url}</span></div>`;
            } else {
                content += `<div><span class="log-status">Response</span></div>`;
            }
            
            if (data) {
                try {
                    content += `<div style="margin-top: 0.25rem; white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</div>`;
                } catch(e) {}
            }

            entry.innerHTML = content;
            container.prepend(entry); // Newest first
        }

        function clearLogs() {
            document.getElementById('logsContent').innerHTML = '<div class="log-entry">Logs cleared...</div>';
        }

        /* --- API Interaction --- */

        async function apiCall(endpoint, method, body = null, isFormData = false) {
            const url = `${API_BASE_URL}${endpoint}`;
            log(method, url, body); // Log request

            const headers = {};
            if (TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;
            if (!isFormData) headers['Content-Type'] = 'application/json';

            try {
                const options = {
                    method,
                    headers,
                    // Important for cookies
                    credentials: 'include' 
                };
                if (body) options.body = isFormData ? body : JSON.stringify(body);

                const res = await fetch(url, options);
                let data;
                const contentType = res.headers.get("content-type");
                
                if (contentType && contentType.indexOf("application/json") !== -1) {
                     data = await res.json();
                } else {
                    data = await res.text();
                }

                log(method, url, data, res.ok ? 'res-ok' : 'res-err'); // Log response
                
                if (!res.ok) {
                    throw new Error(data.message || data.error || 'API Error');
                }
                
                return data;
            } catch (error) {
                log(method, url, { error: error.message }, 'res-err');
                showToast(error.message, 'error');
                throw error;
            }
        }

        /* --- Handlers --- */

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const res = await apiCall('/auth/login', 'POST', { email, password });
                if (res.token) { // If token is returned in body
                    TOKEN = res.token;
                    localStorage.setItem('token', TOKEN);
                } 
                // Note: If server sets httpOnly cookie, it works automatically for subsequent requests
                // We optimistically log in if success
                updateUIState(true);
                showToast('Login Successful!');
                switchView('artifacts');
            } catch (e) { console.error(e); }
        }

        async function handleSignupInitiate() {
            const email = document.getElementById('signupEmail').value;
            try {
                await apiCall('/auth/signup/initiate', 'POST', { email });
                showToast('OTP Sent!');
                showSignupVerify(email);
            } catch(e) { console.error(e); }
        }

        async function handleSignupVerify() {
            const email = document.getElementById('verifyingEmail').innerText;
            const otp = document.getElementById('signupOtp').value;
            const name = document.getElementById('signupName').value;
            const role = document.getElementById('signupRole').value;
            const password = document.getElementById('signupPassword').value;

            try {
                await apiCall('/auth/signup/verify', 'POST', { email, otp, name, password, role });
                showToast('Account Created! Please Login.');
                toggleAuthMode('login');
            } catch(e) { console.error(e); }
        }

        function logout() {
            TOKEN = null;
            localStorage.removeItem('token');
            updateUIState(false);
            // Ideally call logout endpoint if exists to clear cookies
            showToast('Logged Out');
        }

        async function handleCreateArtifact() {
            const title = document.getElementById('artTitle').value;
            const content = document.getElementById('artContent').value;
            const status = document.getElementById('artStatus').value;
            const fileInput = document.getElementById('artFile');
            
            if (!title || !content) {
                showToast('Title and content are required', 'error');
                return;
            }

            if (fileInput.files.length === 0) {
                showToast('Please select a file to upload', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('status', status);
            formData.append('file', fileInput.files[0]);

            try {
                await apiCall('/artifacts', 'POST', formData, true);
                showToast('Artifact Created!');
                // Reset form
                document.getElementById('artTitle').value = '';
                document.getElementById('artContent').value = '';
                document.getElementById('artFile').value = '';
                
                loadArtifacts();
            } catch(e) { console.error(e); }
        }

        async function loadArtifacts() {
            const listEl = document.getElementById('artifactsList');
            listEl.innerHTML = '<div style="color: grey; padding: 1rem;">Loading...</div>';

            try {
                const res = await apiCall('/artifacts', 'GET');
                const artifacts = Array.isArray(res) ? res : (res.artifacts || []);
                
                if (artifacts.length === 0) {
                    listEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: gray;">No artifacts found.</div>';
                    return;
                }

                listEl.innerHTML = artifacts.map(art => `
                    <div class="artifact-card">
                        <img src="${art.media || art.url || 'https://via.placeholder.com/300x150?text=No+Image'}" class="artifact-img" alt="Artifact">
                        <div class="artifact-content">
                            <div class="artifact-title">${art.title || 'Untitled'}</div>
                            <div class="artifact-desc">${art.content || 'No content'}</div>
                            <div class="artifact-meta">
                                <div>${art.author ? (art.author.name || 'Unknown') : 'Unknown Author'}</div>
                                <span class="status-badge status-${art.status || 'DRAFT'}">${art.status || 'DRAFT'}</span>
                            </div>
                            <div style="border-top: 1px solid #f1f5f9; margin-top: 0.5rem; padding-top: 0.5rem; display: flex; justify-content: flex-end;">
                                <button class="like-btn" onclick="toggleLike('${art._id}')">
                                    <span style="font-size: 1.25rem;">♥</span>
                                    <span id="likes-${art._id}">${art.likes ? art.likes.length : (art.likesCount || 0)}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Fetch fresh likes for all (optional optimization: do this separately or rely on list response)
                 artifacts.forEach(art => getLikesCount(art._id));

            } catch(e) { 
                listEl.innerHTML = `<div style="color: red; padding: 1rem;">Failed to load. ${e.message}</div>`;
            }
        }

        async function toggleLike(id) {
            try {
                const res = await apiCall(`/artifacts/${id}/like`, 'POST');
                // Backend returns { liked: boolean } usually, so we re-fetch count or update optimistically
                getLikesCount(id); 
            } catch(e) { console.error(e); }
        }
        
        async function getLikesCount(id) {
             try {
                const res = await apiCall(`/artifacts/${id}/likes`, 'GET');
                // Assuming res is { success: true, count: N }
                if(res.count !== undefined) {
                    const el = document.getElementById(`likes-${id}`);
                    if(el) el.innerText = res.count;
                }
            } catch(e) {}
        }

    </script>
</body>
</html>
